serviceMaps:
  serviceName: bpa-service
  mappings:

    - version: 1.0
      description: Creates BPA application in eg_bpa_buildingplans
      fromTopic: save-bpa-buildingplan
      isTransaction: true
      queryMaps:

        - query: >
            INSERT INTO public.eg_bpa_buildingplans
            (id, application_no, tenant_id, edcr_number, status, application_date,
             approval_no, approval_date, business_service, account_id, application_type,
             risk_type, land_id, created_by, created_time, last_modified_by, last_modified_time, additional_details)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?::JSONB);
          basePath: BPAApplication
          jsonMaps:
            - jsonPath: $.BPAApplication.id
            - jsonPath: $.BPAApplication.applicationNo
            - jsonPath: $.BPAApplication.tenantId
            - jsonPath: $.BPAApplication.edcrNumber
            - jsonPath: $.BPAApplication.status
            - jsonPath: $.BPAApplication.applicationDate
            - jsonPath: $.BPAApplication.approvalNo
            - jsonPath: $.BPAApplication.approvalDate
            - jsonPath: $.BPAApplication.businessService
            - jsonPath: $.BPAApplication.accountId
            - jsonPath: $.BPAApplication.applicationType
            - jsonPath: $.BPAApplication.riskType
            - jsonPath: $.BPAApplication.landId
            - jsonPath: $.BPAApplication.auditDetails.createdBy
            - jsonPath: $.BPAApplication.auditDetails.createdTime
            - jsonPath: $.BPAApplication.auditDetails.lastModifiedBy
            - jsonPath: $.BPAApplication.auditDetails.lastModifiedTime
            - jsonPath: $.BPAApplication.additionalDetails
              type: JSON
              dbType: JSONB

        - query: >
            INSERT INTO public.eg_bpa_documents
            (id, document_type, filestore_id, document_uid, buildingplan_id,
             created_by, created_time, last_modified_by, last_modified_time, additional_details)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?::JSONB);
          basePath: BPAApplication.documents.*
          jsonMaps:
            - jsonPath: $.BPAApplication.documents.*.id
            - jsonPath: $.BPAApplication.documents.*.documentType
            - jsonPath: $.BPAApplication.documents.*.fileStoreId
            - jsonPath: $.BPAApplication.documents.*.documentUid
            - jsonPath: $.BPAApplication.id
            - jsonPath: $.BPAApplication.auditDetails.createdBy
            - jsonPath: $.BPAApplication.auditDetails.createdTime
            - jsonPath: $.BPAApplication.auditDetails.lastModifiedBy
            - jsonPath: $.BPAApplication.auditDetails.lastModifiedTime
            - jsonPath: $.BPAApplication.documents.*.additionalDetails
              type: JSON
              dbType: JSONB

        - query: >
            INSERT INTO public.ug_bpa_rtp_details
            (id, buildingplan_id, rtp_category, rtp_id, rtp_name,
             assignment_status, assignment_date, expiry_date,
             created_by, created_time, last_modified_by, last_modified_time, additional_details)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?::JSONB);
          basePath: BPAApplication.rtpDetails.*
          jsonMaps:
            - jsonPath: $.BPAApplication.rtpDetails.*.id
            - jsonPath: $.BPAApplication.id
            - jsonPath: $.BPAApplication.rtpDetails.*.rtpCategory
            - jsonPath: $.BPAApplication.rtpDetails.*.rtpId
            - jsonPath: $.BPAApplication.rtpDetails.*.rtpName
            - jsonPath: $.BPAApplication.rtpDetails.*.assignmentStatus
            - jsonPath: $.BPAApplication.rtpDetails.*.assignmentDate
            - jsonPath: $.BPAApplication.rtpDetails.*.expiryDate
            - jsonPath: $.BPAApplication.auditDetails.createdBy
            - jsonPath: $.BPAApplication.auditDetails.createdTime
            - jsonPath: $.BPAApplication.auditDetails.lastModifiedBy
            - jsonPath: $.BPAApplication.auditDetails.lastModifiedTime
            - jsonPath: $.BPAApplication.rtpDetails.*.additionalDetails
              type: JSON
              dbType: JSONB

    - version: 1.0
      description: Updates BPA application and maintains audit trail
      fromTopic: update-bpa-buildingplan
      isTransaction: true
      queryMaps:

        - query: >
            UPDATE public.eg_bpa_buildingplans
            SET status = ?, approval_no = ?, approval_date = ?, risk_type = ?,
                last_modified_by = ?, last_modified_time = ?, additional_details = ?::JSONB
            WHERE id = ?;
          basePath: BPAApplication
          jsonMaps:
            - jsonPath: $.BPAApplication.status
            - jsonPath: $.BPAApplication.approvalNo
            - jsonPath: $.BPAApplication.approvalDate
            - jsonPath: $.BPAApplication.riskType
            - jsonPath: $.BPAApplication.auditDetails.lastModifiedBy
            - jsonPath: $.BPAApplication.auditDetails.lastModifiedTime
            - jsonPath: $.BPAApplication.additionalDetails
              type: JSON
              dbType: JSONB
            - jsonPath: $.BPAApplication.id

        - query: INSERT INTO public.eg_bpa_buildingplans_audit SELECT * FROM public.eg_bpa_buildingplans WHERE id = ?;
          basePath: BPAApplication
          jsonMaps:
            - jsonPath: $.BPAApplication.id

        - query: INSERT INTO public.eg_bpa_documents_audit SELECT * FROM public.eg_bpa_documents WHERE id = ?;
          basePath: BPAApplication.documents.*
          jsonMaps:
            - jsonPath: $.BPAApplication.documents.*.id

        - query: INSERT INTO public.ug_bpa_rtp_details_audit SELECT * FROM public.ug_bpa_rtp_details WHERE id = ?;
          basePath: BPAApplication.rtpDetails.*
          jsonMaps:
            - jsonPath: $.BPAApplication.rtpDetails.*.id
